# 軟硬體開發架構與互動流程圖

本文件描述「房東物件管理語音 AI App」的系統架構與使用者互動流程。

## 1. 系統架構圖 (System Architecture)

此圖表展示了地端硬體設施 (Home Server) 與雲端服務、使用者端應用程式之間的關係。

```mermaid
graph TB
    subgraph Client_Side ["Client Side 使用者端"]
        MobileApp["Expo Mobile App (iOS / Android)"]
        WebApp["Web Dashboard (React / Expo Web)"]
        MobileSTT["Mobile Built-in STT (Apple/Android Speech)"]
    end

    subgraph Home_Server ["Home Server MSI Desktop PC"]
        subgraph Infrastructure ["Infrastructure 基礎設施"]
            GPU["RTX 3090 GPU"]
            CPU["16-Core CPU"]
            Storage["4T+1T SSD"]
        end

        subgraph Backend_Core ["Backend Core 後端核心"]
            RasaCore["Rasa AI Assistant 對話管理 & 意圖識別"]
            LLM_Proxy["LLM Proxy Orchestrator (LangChain/Node.js)"]
            FunASR["FunASR 備用 STT 服務"]
        end

        subgraph AI_Agents ["AI Agents 功能代理人"]
            WebAgent["Website Creator Agent 生成行銷網頁"]
            LegalAgent["Legal Agent 合約起草 & 審核"]
            AcctAgent["Accountant Agent 稅務 & 報表"]
            ConciergeAgent["Concierge Agent 維修 & 行事曆"]
            IDP["IDP Document Parser OCR & 文件理解"]
        end

        subgraph Data_Persistence ["Data Persistence 資料持久化"]
            PostgreSQL["PostgreSQL 主資料庫<br/>(JSONB 儲存謄本資料)"]
            MinIO["MinIO Object Storage 文件與照片儲存"]
            ClickHouse["ClickHouse 分析型資料庫<br/>(可選，用於財務報表)"]
        end
        
        subgraph Backend_Process ["Backend Process 後端處理"]
            BackendAPI["Backend API (Node.js)<br/>業務邏輯 & LLM Proxy"]
        end
    end

    subgraph External_Services ["External Services 第三方整合"]
        LLM_API["LLM APIs (OpenAI GPT-4o / Claude 3.5)"]
        Payment["Stripe Connect 金流 & 分潤"]
        Comm["Twilio/Fonoster/Resend 簡訊 & Email"]
        Sign["DocuSeal / HelloSign 電子簽章"]
    end

    %% Client Connections
    MobileApp -- HTTPS/WebSocket --> RasaCore
    WebApp -- HTTPS/WebSocket --> RasaCore
    MobileApp -- 語音轉文字 --> MobileSTT
    MobileSTT -- Text --> MobileApp

    %% Backend Flow
    RasaCore -- 意圖解析 --> LLM_Proxy
    LLM_Proxy -- 調用模型 --> LLM_API
    LLM_Proxy -- 分派任務 --> WebAgent
    LLM_Proxy -- 分派任務 --> LegalAgent
    LLM_Proxy -- 分派任務 --> AcctAgent
    LLM_Proxy -- 分派任務 --> ConciergeAgent
    
    %% Backend Process Connections
    LLM_Proxy --> BackendAPI
    BackendAPI --> PostgreSQL
    BackendAPI --> MinIO
    BackendAPI --> RasaCore
    
    %% Agent Actions
    IDP -- 解析文件 --> LLM_API
    IDP -- 儲存資料 --> PostgreSQL
    WebAgent -- 儲存網頁資源 --> MinIO
    LegalAgent -- 發起簽約 --> Sign
    AcctAgent -- 查詢數據 --> PostgreSQL
    AcctAgent -- 分析查詢 --> ClickHouse
    ConciergeAgent -- 發送通知 --> Comm
    
    %% Agent to Backend
    WebAgent --> BackendAPI
    LegalAgent --> BackendAPI
    AcctAgent --> BackendAPI
    ConciergeAgent --> BackendAPI
    IDP --> BackendAPI

    %% Hardware Usage
    FunASR --> GPU
    IDP --> GPU
    MinIO --> Storage
    PostgreSQL --> Storage
    ClickHouse --> Storage
```

---

## 2. 核心互動流程 (Core Interaction Flow)

以下流程圖展示房東透過語音指令，驅動 AI 助理完成「物件上架」與「合約製作」的過程。

### 2.1 場景一：物件上架與網頁生成 (Listing Creation)

```mermaid
sequenceDiagram
    autonumber
    actor Landlord as 房東 Landlord
    participant App as App Expo
    participant Rasa as Rasa AI Core
    participant IDP as IDP Agent
    participant WebAgent as Website Agent
    participant MinIO as MinIO
    participant DB as PostgreSQL

    Landlord->>App: 我想出租房子，幫我做廣告頁面 (語音輸入)
    App->>App: 手機 STT 轉文字
    App->>Rasa: 發送文字意圖
    Rasa->>App: 回覆: 請上傳照片與權狀文件
    
    Landlord->>App: 上傳照片與權狀 PDF
    App->>MinIO: 儲存原始檔案
    App->>Rasa: 通知上傳完成
    
    Rasa->>IDP: 觸發文件解析任務 (權狀)
    activate IDP
    IDP->>MinIO: 讀取權狀 PDF
    IDP->>IDP: OCR & LLM 欄位提取 (地址/坪數/屋主)
    IDP->>DB: 寫入房屋基本資料 (JSONB)
    IDP-->>Rasa: 解析完成
    deactivate IDP

    Rasa->>WebAgent: 觸發網頁生成任務
    activate WebAgent
    WebAgent->>DB: 讀取房屋資料
    WebAgent->>MinIO: 讀取房屋照片
    WebAgent->>WebAgent: 套用模板 & 生成文案 (LLM)
    WebAgent->>MinIO: 部署靜態網頁
    WebAgent-->>Rasa: 回傳網頁 URL
    deactivate WebAgent

    Rasa->>App: 回覆: 網頁已生成，點此預覽: [URL]
    App->>Landlord: 顯示預覽連結
```

### 2.2 場景二：租客篩選與電子簽約 (Screening & Leasing)

```mermaid
sequenceDiagram
    autonumber
    actor Landlord as 房東
    participant Rasa as Rasa AI Core
    participant Legal as Legal Agent
    participant Sign as DocuSeal
    participant Tenant as 準租客

    Landlord->>Rasa: 決定租給張先生，幫我準備一年合約，禁養寵物
    Rasa->>Legal: 指派合約起草任務 (Tenant=張先生, Term=1年, Note=禁寵)
    
    activate Legal
    Legal->>Legal: 調用 LLM 生成合約條款
    Legal->>Sign: 呼叫 API 建立簽署文件
    Sign-->>Legal: 回傳簽署連結 Signing URL
    deactivate Legal

    Rasa->>Landlord: 回覆: 合約已寄給張先生簽名
    
    Legal->>Sign: 發送簽署邀請 Email
    Sign->>Tenant: 收到簽署通知
    Tenant->>Sign: 完成電子簽名
    Sign-->>Legal: Webhook 通知: 簽署完成
    
    Legal->>Rasa: 更新合約狀態為 Active
    Rasa->>Landlord: 推播通知: 張先生已完成簽約，合約生效
```

### 2.3 場景三：財務報表查詢 (Financial Reporting)

```mermaid
sequenceDiagram
    autonumber
    actor Landlord as 房東
    participant Rasa as Rasa AI Core
    participant Acct as Accountant Agent
    participant DB as PostgreSQL
    participant ClickHouse as ClickHouse (可選)
    participant GenDoc as PDF Generator

    Landlord->>Rasa: 上季租金收入多少？我要報稅表
    Rasa->>Acct: 查詢財務數據 (Range=Last Quarter)
    
    activate Acct
    Acct->>DB: SQL Query (Sum Income, Expenses)
    DB-->>Acct: 回傳數據 (145000 / 132000)
    Note over Acct,ClickHouse: 如需複雜分析，可查詢 ClickHouse
    Acct-->>Rasa: 回傳摘要數據
    deactivate Acct

    Rasa->>Landlord: 語音回覆: 上季總收入 14.5 萬，淨利 13.2 萬
    
    Rasa->>Acct: 指令: 生成報稅報表
    activate Acct
    Acct->>GenDoc: 匯入數據至 ATO 格式模板
    GenDoc-->>Acct: 產出 PDF
    Acct->>Rasa: 回傳 PDF 下載連結
    deactivate Acct

    Rasa->>Landlord: 顯示 PDF 下載按鈕
```

## 3. 架構說明

### 3.1 資料庫選擇

- **PostgreSQL (主資料庫)**：
  - 儲存謄本 PDF 解析後的 JSON 資料（使用 JSONB 類型）
  - 物件基本資料、租賃合約、租客資料、財務記錄等
  - 支援關聯查詢、ACID 事務、單筆物件查詢效能佳

- **ClickHouse (分析型資料庫，可選)**：
  - 僅用於大規模分析型查詢
  - 財務報表統計、跨物件數據聚合查詢
  - 不建議用於日常的物件資料儲存與查詢

### 3.2 後端架構

- **Backend API (Node.js)**：
  - 使用 Node.js + Express/Fastify + LangChain
  - 處理業務邏輯、LLM Proxy Orchestrator
  - 與 AI Agents 整合、資料庫操作、檔案管理

- **Rasa (Python)**：
  - AI 語音助手框架
  - 對話管理與意圖識別
  - 通過 HTTP API 與 Node.js 後端通信

### 3.3 前端架構

- **Expo**：
  - 移動端應用（iOS/Android）
  - Web Dashboard（Expo Web）
  - 通過 HTTPS/WebSocket 與後端通信
