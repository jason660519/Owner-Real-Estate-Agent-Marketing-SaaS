# Supabase + Rasa 架構說明

## 服務架構總覽

本專案採用 **Supabase** 作為後端服務（BaaS），搭配 **Rasa** AI 對話引擎，打造房地產仲介 SaaS 平台。



## 服務清單

### 1. 後端服務（Supabase）

#### Supabase (BaaS - Backend as a Service)
- **服務**: 開源 Firebase 替代方案
- **本地開發**: Docker Compose（http://localhost:54321）
- **正式環境**: Supabase Cloud 或自架部署
- **核心功能**:
  - **PostgreSQL 資料庫**: 
    - 儲存謄本 PDF 解析後的 JSON 資料（JSONB 類型）
    - 物件基本資料（地址、坪數、屋主資訊等）
    - 物件與照片的關聯關係
    - 租賃合約、租客資料、財務記錄等業務資料
  - **Storage (檔案儲存)**:
    - 房東的物件照片
    - 物件說明文檔
    - 合約檔案
  - **Authentication (身份驗證)**:
    - 房東/仲介帳號管理
    - JWT 令牌驗證
    - Row Level Security (RLS) 多租戶隔離
  - **Realtime (即時訂閱)**:
    - 物件狀態即時更新
    - 新客戶詢問即時通知
  - **Edge Functions (無伺服器函數)**:
    - PDF 解析處理
    - 第三方 API 整合


### 2. 快取與會話儲存（可選）

### 3. AI 服務

#### Rasa 
- **容器名稱**: `owner_saas_rasa`
- **端口**: `5005` (HTTP API)
- **用途**:
  - AI 語音助手框架
  - 對話管理與意圖識別
  - 自然語言處理
- **依賴**: 
  - Supabase PostgreSQL (用於 tracker store)


### 4. 前端服務

#### Frontend (Expo React Native + Web)
- **容器名稱**: `owner_saas_frontend`
- **端口**: `8081` (Expo Dev Server)
- **用途**:
  - Mobile App (iOS/Android)
  - Web Dashboard
  - 用戶介面
- **環境變數**:
  - `EXPO_PUBLIC_SUPABASE_URL`: Supabase 專案網址
  - `EXPO_PUBLIC_SUPABASE_ANON_KEY`: Supabase 匿名金鑰
  - `EXPO_PUBLIC_RASA_URL`: Rasa API 地址

### 5. 可選服務

#### Cloudflare Tunnel ⚠️ **可選，已註解**
- **用途**: 提供安全的公網訪問，無需開放端口
- **狀態**: 需要時再啟用

## 服務依賴關係


## 服務啟動順序

### 本地開發環境
1. **Supabase 基礎設施**:
   ```bash
   npx supabase start
   ```
   - PostgreSQL (資料庫)
   - Storage (檔案儲存)
   - Auth (身份驗證)
   - Realtime (即時訂閱)

2. **AI 服務層**:
   - Rasa (Docker 容器)

3. **應用層**:
   - Backend (等待所有依賴就緒)
   - Frontend (等待 Backend 就緒)

## 環境變數配置

### 開發環境
- 使用預設值（可配置在 docker-compose.yml）
- 所有服務使用預設帳號密碼

3. **前端應用層**:
   - Expo (連接 Supabase + Rasa)

## 環境變數配置

### 本地開發環境
```bash
# .env.local
EXPO_PUBLIC_SUPABASE_URL=http://localhost:54321
EXPO_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
EXPO_PUBLIC_RASA_URL=http://localhost:5005
```

### 生產環境
```bash
# .env.production
EXPO_PUBLIC_SUPABASE_URL=https://yourproject.supabase.co
EXPO_PUBLIC_SUPABASE_ANON_KEY=<your-production-key>
EXPO_PUBLIC_RASA_URL=https://rasa.yourapp.com
```

## 資料持久化

### Supabase
- PostgreSQL 資料由 Supabase 自動管理
- Storage 檔案由 Supabase 自動管理
- 定期備份透過 Supabase Dashboard

### Rasa (Docker Volume)
- `rasa_models`: Rasa 訓練模型

## 網路架構

```
使用者
  ↓
前端 App (Expo)
  ↓         ↓
Supabase   Rasa
  ↓
PostgreSQL + Storage + Auth
```

## 端口映射

| 服務 | 本地開發端口 | 正式環境 |
|------|------------|---------|
| Supabase API | 54321 | HTTPS |
| Supabase Studio | 54323 | Dashboard |
| Rasa | 5005 | 自訂域名 |
| Expo Dev | 8081 | PWA/App |

## 快速開始

### 1. 安裝 Supabase CLI
```bash
# Mac
brew install supabase/tap/supabase

# 驗證安裝
supabase --version
```

### 2. 初始化 Supabase 專案
```bash
# 在專案根目錄
npx supabase init

# 啟動本地 Supabase
npx supabase start
```

### 3. 建立 Rasa 容器（可選）
```bash
# 如需要 AI 對話功能
docker run -d \
  --name owner_saas_rasa \
  -p 5005:5005 \
  rasa/rasa:latest
```

### 4. 啟動前端開發
```bash
cd frontend
npm install
npx expo start
```

### 5. 訪問服務
- Supabase Studio: `http://localhost:54323`
- Expo Dev: `http://localhost:8081`
- Rasa API: `http://localhost:5005`

## 故障排除

### Supabase 無法啟動
```bash
# 檢查 Docker 狀態
docker ps

# 重啟 Supabase
npx supabase stop
npx supabase start
```

### 查看 Supabase 服務資訊
```bash
npx supabase status
```

### 重置資料庫
```bash
npx supabase db reset
```

## 參考文件

- [三階段部署說明](./三階段部署說明.md)
- [專案架構選型建議書](./專案架構選型/專案架構選型建議書.md)
- [資料庫選型建議](./資料庫選型建議.md)
