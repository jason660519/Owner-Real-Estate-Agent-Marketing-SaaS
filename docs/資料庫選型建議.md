# 資料庫選型建議書

## ✅ 最終決策：採用 Supabase

基於專案需求分析，我們決定採用 **Supabase** 作為後端解決方案。

### 選擇 Supabase 的核心原因

1. **完整的 BaaS 功能**
   - PostgreSQL 資料庫（強大的 JSONB 支援）
   - 檔案儲存（Storage）
   - 身份驗證（Authentication）
   - 即時訂閱（Realtime）
   - 無伺服器函數（Edge Functions）

2. **開發效率極高**
   - 無需自建後端 API
   - 自動生成 REST/GraphQL API
   - Row Level Security (RLS) 內建多租戶支援
   - 本地開發環境完善（Docker）

3. **成本優勢**
   - 開發階段：完全免費（本地 Docker）
   - 測試階段：免費方案（500MB 資料庫、1GB 儲存）
   - 正式環境：$25/月起（8GB 資料庫、100GB 儲存）

4. **擴展性佳**
   - 從免費到企業方案無縫升級
   - 支援自架部署（完全掌控）
   - PostgreSQL 生態系統完整

---

## 原始問題分析

### 原始方案：使用 ClickHouse 儲存謄本 PDF 解析後的 JSON

**ClickHouse 的特性：**
- ✅ 列式儲存，適合分析型查詢
- ✅ 高壓縮率，節省儲存空間
- ✅ 批量寫入效能優秀
- ❌ **更新操作複雜**：需要 ALTER TABLE 或重新插入整行
- ❌ **關聯查詢效能較差**：JOIN 操作不如關聯式資料庫
- ❌ **JSON 查詢能力有限**：不如 PostgreSQL 的 JSONB 強大
- ❌ **單筆查詢效能較弱**：適合聚合查詢，不適合快速讀取單筆完整資料

### 專案實際需求

1. **謄本資料儲存**：PDF 解析後的 JSON 資料
2. **資料關聯**：需要與物件照片、屋主資料建立關聯
3. **資料更新**：解析結果可能需要人工修正
4. **快速查詢**：生成物件廣告頁面需要快速讀取完整物件資訊
5. **分析查詢**：財務報表、統計分析（次要需求）

---

## Supabase (PostgreSQL) 方案詳解

### 適用場景
- ✅ 日常的物件資料管理
- ✅ 謄本 JSON 資料儲存與查詢
- ✅ 物件與照片的關聯查詢
- ✅ 生成物件廣告頁面
- ✅ 多租戶資料隔離（RLS）
- ✅ 即時資料訂閱

### 技術優勢

#### 1. JSONB 強大功能
```sql
-- 儲存謄本解析結果
CREATE TABLE properties (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    agent_id UUID REFERENCES auth.users(id),
    address TEXT NOT NULL,
    district TEXT,
    total_area NUMERIC,
    transcript_data JSONB,  -- 完整的謄本解析 JSON
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 強大的 JSON 查詢
SELECT 
    id,
    address,
    transcript_data->>'owner_name' as owner_name,
    transcript_data->>'total_area' as area
FROM properties
WHERE transcript_data @> '{"district": "信義區"}';

-- JSON 索引支援
CREATE INDEX idx_transcript_data 
ON properties USING GIN (transcript_data jsonb_path_ops);
```

#### 2. Row Level Security (RLS) - 多租戶隔離
```sql
-- 啟用 RLS
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;

-- 仲介只能看到自己的物件
CREATE POLICY "仲介只能查看自己的物件"
    ON properties FOR SELECT
    USING (auth.uid() = agent_id);

CREATE POLICY "仲介只能新增自己的物件"
    ON properties FOR INSERT
    WITH CHECK (auth.uid() = agent_id);
```

#### 3. 優秀的關聯查詢
```sql
-- 查詢物件完整資訊（包含照片）
SELECT 
    p.*,
    json_agg(ph.*) as photos,
    p.transcript_data as building_info
FROM properties p
LEFT JOIN property_photos ph ON ph.property_id = p.id
WHERE p.id = '123'
GROUP BY p.id;
```

#### 4. Supabase 額外功能
```typescript
// 前端直接查詢，無需建立 API
import { createClient } from '@supabase/supabase-js'

const supabase = createClient(supabaseUrl, supabaseKey)

// 查詢物件
const { data, error } = await supabase
  .from('properties')
  .select(`
    *,
    property_photos (*)
  `)
  .eq('agent_id', userId)
  .order('created_at', { ascending: false })

// 即時訂閱
supabase
  .channel('properties')
  .on('postgres_changes', 
    { event: 'INSERT', schema: 'public', table: 'properties' },
    (payload) => console.log('新物件:', payload)
  )
  .subscribe()

// 檔案上傳
const { data, error } = await supabase.storage
  .from('property-photos')
  .upload(`${propertyId}/photo.jpg`, file)
```

### 部署選項

#### 選項 1: Supabase Cloud（推薦）
```bash
# 優點
✅ 即開即用，無需維護
✅ 自動備份
✅ 自動擴展
✅ 免費方案可開始

# 成本
- 免費: 500MB DB, 1GB Storage
- Pro: $25/月, 8GB DB, 100GB Storage
- Team: $599/月, 無限 DB
```

#### 選項 2: 自架 Supabase（進階）
```bash
# 使用 Docker Compose
git clone https://github.com/supabase/supabase
cd supabase/docker
cp .env.example .env

# 修改配置
# 啟動
docker-compose up -d

# 優點
✅ 完全掌控
✅ 可部署到自己的伺服器
✅ 無資料傳輸費用

# 缺點
❌ 需要維護
❌ 需要自己設定備份
❌ 需要監控和更新
```

#### 選項 3: 本地開發
```bash
# 使用 Supabase CLI
npm install -g supabase
supabase init
supabase start

# 本地服務
API: http://localhost:54321
Studio: http://localhost:54323
DB: postgresql://postgres:postgres@localhost:54322/postgres
```

---

## 替代方案：PostgreSQL + ClickHouse 混合架構（不推薦）

**僅在以下情況考慮：**
- 有專職 DevOps 團隊
- 需要複雜的財務分析（> 10萬筆交易）
- 已有 ClickHouse 經驗

**架構設計：**
- **Supabase PostgreSQL**：主資料庫（OLTP）
  - 儲存所有業務資料
  - 處理日常查詢與更新
  
- **ClickHouse**：分析資料庫（OLAP）
  - 從 PostgreSQL 定期同步資料
  - 僅用於財務報表、統計分析

**注意：**
- ⚠️ 增加系統複雜度
- ⚠️ 需要額外維護成本
- ⚠️ 初期不建議使用

---

## 決策建議

### 階段一：本地開發（現在）
```bash
✅ 使用 Supabase CLI 本地環境
- 完全免費
- Docker 一鍵啟動
- 與正式環境一致
```

### 階段二：測試上線（1-3 個月）
```bash
✅ Supabase Cloud 免費方案
- 無需配置
- 500MB 資料庫足夠 MVP
- 隨時可升級
```

### 階段三：正式營運（3 個月後）
```bash
✅ Supabase Cloud Pro ($25/月)
- 8GB 資料庫
- 100GB 儲存
- 每日自動備份
- 優先支援
```

### 未來擴展（1 年後，可選）
```bash
⚠️ 考慮自架 Supabase
- 當月成本 > $500
- 需要特殊合規要求
- 有專職運維團隊
```

---

## 與其他方案對比

| 項目 | Supabase | PocketBase | NestJS + PostgreSQL |
|------|----------|------------|-------------------|
| 開發速度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| 功能完整度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| 擴展性 | ⭐⭐⭐⭐⭐ | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| 學習曲線 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| 維護成本 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| 初期成本 | 免費 | 免費 | VPS $10/月 |
| 正式成本 | $25/月 | VPS $10/月 | VPS $50/月 |

**結論：** Supabase 在開發速度、功能完整度和維護成本上最優。

---

## 常見問題

### Q: Supabase 和 Firebase 的差異？
**A:** 
- Supabase 使用 PostgreSQL（關聯式）vs Firebase 使用 NoSQL
- Supabase 開源 vs Firebase 閉源
- Supabase 支援 SQL 查詢 vs Firebase 查詢能力有限
- Supabase 可自架 vs Firebase 只能用 Google Cloud

### Q: 如果 Supabase 倒閉怎麼辦？
**A:**
- ✅ 開源專案，可自架
- ✅ 標準 PostgreSQL，資料可匯出
- ✅ 社群活躍，有替代方案（Nhost、PocketBase）

### Q: 資料量很大時怎麼辦？
**A:**
- Supabase 支援擴展到 TB 級別
- 可使用 PostgreSQL 分區表
- 可升級到 Team/Enterprise 方案
- 最終可自架 PostgreSQL 叢集

### Q: 需要離線功能怎麼辦？
**A:**
```typescript
// 使用 Supabase + 本地快取
import { createClient } from '@supabase/supabase-js'
import AsyncStorage from '@react-native-async-storage/async-storage'

const supabase = createClient(url, key, {
  auth: {
    storage: AsyncStorage,
    autoRefreshToken: true,
    persistSession: true
  }
})

// 或使用 expo-sqlite 本地資料庫
import * as SQLite from 'expo-sqlite'
```

---

## 結論

✅ **採用 Supabase 作為後端解決方案**

**核心理由：**
1. PostgreSQL JSONB 完美符合謄本資料儲存需求
2. Row Level Security 天生支援多租戶 SaaS
3. 開發效率極高，無需建立傳統後端 API
4. 成本低（免費起步，$25/月正式營運）
5. 可隨時遷移到自架方案

**下一步：**
- [ ] 安裝 Supabase CLI
- [ ] 啟動本地開發環境
- [ ] 建立資料庫 Schema
- [ ] 整合到前端專案
- [ ] 查閱[三階段部署說明](./三階段部署說明.md)

---

**最後更新：** 2026-01-12  
**決策狀態：** ✅ 已確認  
**負責人：** Owner Real Estate Agent SaaS Team
- 需要額外的 ETL 流程維護成本

## 資料庫架構設計建議

### PostgreSQL 核心資料表

```sql
-- 1. 屋主資料表
CREATE TABLE owners (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) UNIQUE NOT NULL,
    email VARCHAR(255),
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. 物件資料表
CREATE TABLE properties (
    id SERIAL PRIMARY KEY,
    owner_id INTEGER REFERENCES owners(id),
    address TEXT NOT NULL,
    district VARCHAR(50),
    property_type VARCHAR(50),
    status VARCHAR(20) DEFAULT 'draft', -- draft, listed, rented
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 3. 謄本資料表（使用 JSONB）
CREATE TABLE building_transcripts (
    id SERIAL PRIMARY KEY,
    property_id INTEGER REFERENCES properties(id),
    transcript_data JSONB NOT NULL,  -- 完整的謄本解析 JSON
    parsing_confidence FLOAT,  -- 解析信心度
    needs_review BOOLEAN DEFAULT FALSE,  -- 是否需要人工審核
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. 照片資料表
CREATE TABLE property_photos (
    id SERIAL PRIMARY KEY,
    property_id INTEGER REFERENCES properties(id),
    minio_path VARCHAR(500) NOT NULL,  -- MinIO 儲存路徑
    photo_order INTEGER,  -- 照片順序
    is_primary BOOLEAN DEFAULT FALSE,  -- 是否為主圖
    created_at TIMESTAMP DEFAULT NOW()
);

-- 5. 廣告頁面資料表
CREATE TABLE property_listings (
    id SERIAL PRIMARY KEY,
    property_id INTEGER REFERENCES properties(id),
    listing_url VARCHAR(500) UNIQUE,
    template_id VARCHAR(50),
    generated_content JSONB,  -- 生成的文案內容
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 建立索引
CREATE INDEX idx_transcript_property ON building_transcripts(property_id);
CREATE INDEX idx_transcript_json ON building_transcripts USING GIN (transcript_data);
CREATE INDEX idx_photos_property ON property_photos(property_id);
CREATE INDEX idx_listings_property ON property_listings(property_id);
```

### 查詢範例

```sql
-- 生成物件廣告頁面所需的完整資料
SELECT 
    p.id,
    p.address,
    p.district,
    p.property_type,
    o.name as owner_name,
    o.phone as owner_phone,
    bt.transcript_data as building_info,
    json_agg(
        json_build_object(
            'id', ph.id,
            'url', ph.minio_path,
            'order', ph.photo_order,
            'is_primary', ph.is_primary
        ) ORDER BY ph.photo_order
    ) as photos,
    pl.listing_url,
    pl.generated_content
FROM properties p
JOIN owners o ON o.id = p.owner_id
LEFT JOIN building_transcripts bt ON bt.property_id = p.id
LEFT JOIN property_photos ph ON ph.property_id = p.id
LEFT JOIN property_listings pl ON pl.property_id = p.id
WHERE p.id = $1
GROUP BY p.id, o.id, bt.id, pl.id;
```

## 實施建議

### 階段一：初期開發（推薦）
- ✅ 使用 **PostgreSQL** 作為唯一資料庫
- ✅ 使用 JSONB 儲存謄本解析結果
- ✅ 建立完整的關聯資料表結構
- ✅ 實作物件廣告頁面生成功能

### 階段二：規模擴展（可選）
- 當財務分析需求增加時
- 引入 **ClickHouse** 作為分析資料庫
- 建立 ETL 流程同步資料
- 將分析型查詢遷移至 ClickHouse

## 總結

**建議採用 PostgreSQL 作為主資料庫**，原因：

1. ✅ **完美支援 JSON 儲存與查詢**：JSONB 類型提供強大的查詢能力
2. ✅ **優秀的關聯查詢效能**：物件、照片、屋主資料的 JOIN 操作高效
3. ✅ **適合頻繁更新**：支援 ACID 事務，資料修正操作簡單
4. ✅ **單筆查詢效能佳**：生成廣告頁面時能快速讀取完整資料
5. ✅ **生態系統完整**：與 Expo、Django、Rasa 等技術棧整合容易

**ClickHouse 僅建議在以下情況使用：**
- 需要大規模財務報表分析
- 跨物件統計查詢需求增加
- 資料量達到數百萬筆以上

**初期專案建議：先使用 PostgreSQL，待需求明確後再考慮引入 ClickHouse。**
